apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../kustomize/base
  - ../../kustomize/workloads/statefulset
  - secrets.yaml

components:
  - ../../kustomize/components/ingress
  - ../../kustomize/components/direct-ingress
  - ../../kustomize/components/security-context

namePrefix: n8n-
labels:
  - pairs:
      app.kubernetes.io/name: n8n
    includeSelectors: true

images:
  - name: busybox
    newName: n8nio/n8n
    newTag: 2.4.5@sha256:1e57b650fa1884af5c52cac2e3d9f05bb6701a6b4214bb74d2a334cc0bb9296d

configMapGenerator:
  - name: domain-config
    literals:
      - DOMAIN=n8n.internal
      - DIRECT_DOMAIN=n8n.anshulg.direct
  - name: env-config
    literals:
      - TZ=America/Los_Angeles
      - N8N_USER_FOLDER=/data
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_RUNNERS_ENABLED=true
      - N8N_RESTRICT_FILE_ACCESS_TO=/data/.n8n-files
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=rpi4.anshulg.direct
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_SCHEMA=public
      - DB_POSTGRESDB_SSL_ENABLED=true
      - DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED=false
      - DB_POSTGRESDB_SSL_CA=/etc/ssl/certs/ca-certificates.crt

patches:
  - target:
      kind: StatefulSet
    path: patch-statefulset.yaml
  - target:
      kind: StatefulSet
    path: patch-statefulset2.yaml
  - target:
      kind: Service
    path: patch-service.yaml
