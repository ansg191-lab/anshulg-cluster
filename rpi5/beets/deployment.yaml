apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: beets
  labels:
    app: beets
spec:
  replicas: 1
  selector:
    matchLabels:
      app: beets
  template:
    metadata:
      name: beets
      labels:
        app: beets
    spec:
      containers:
        - name: beets
          image: ghcr.io/ansg191-lab/containers/beets:v2.4.0.1@sha256:6fef4458aec14b989bc37749ca93fa35582b7a05173d32bb87a0f45cd3ee0962
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: env
          command:
            - /bin/sh
            - -c
            - |
              echo "Started beets container"
              exec tail -f /dev/null
          securityContext:
            runAsUser: 2017
            runAsGroup: 3002
            privileged: false
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - mountPath: /music
              name: music
            - mountPath: /seedbox
              name: data
            - mountPath: /.config/beets/config.yaml
              name: config
              subPath: config.yaml
        - name: lftp
          image: debian:13.1-slim@sha256:1caf1c703c8f7e15dcf2e7769b35000c764e6f50e4d7401c355fb0248f3ddfdb
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: env
          command:
            - /bin/sh
            - -c
            - |
              echo "Started lftp container"
              set -e
              exec tail -f /dev/null
#              apt-get update && apt-get install -y lftp
#              setpriv --reuid 2017 --regid 3002 --clear-groups lftp -u $LFTP_USER,$LFTP_PASS $LFTP_HOST -e "
#              set ssl:verify-certificate false;
#              set net:connection-limit 32;
#              set mirror:use-pget-n 16;
#              set mirror:parallel-transfer-count 4;
#              mirror --continue $LFTP_REMOTE_DIR /seedbox;
#              bye;
#              "
          volumeMounts:
            - mountPath: /seedbox
              name: data
      restartPolicy: Always
      securityContext:
        fsGroup: 3002
      volumes:
        - name: music
          hostPath:
            path: /data/Music2
        - name: config
          secret:
            secretName: config
      nodeSelector:
        kubernetes.io/hostname: odroid-h4
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 1Gi
