apiVersion: v1
kind: ConfigMap
metadata:
  name: natpmp-script
data:
  entrypoint.sh: |
    #!/bin/sh
    set -e

    # Install dependencies
    apt-get update
    apt-get install -y natpmpc iproute2 curl

    # Check that the default route is via the WireGuard interface
    ip route get 1.1.1.1 | grep -q "dev wg0"
    if [ $? -ne 0 ]; then
        echo "Default route is not via wg0. Exiting."
        exit 1
    fi

    # Wait for qbittorrent to be ready
    echo "Waiting for qbittorrent to be ready..."
    curl --retry 10 --retry-delay 6 --retry-connrefused --silent --show-error http://localhost:8080/api/v2/app/version || {
        echo "qbittorrent is not reachable. Exiting."
        exit 1
    }

    # Renew NAT-PMP mapping every 45 seconds
    while true; do
        echo "Renewing NAT-PMP mapping..."
        date

        natpmpc -a 1 0 udp 60 -g 10.2.0.1
        PORT=$(natpmpc -a 1 0 tcp 60 -g 10.2.0.1 | tee /dev/tty | grep "public port" | awk '{print $4}')

        echo "NAT-PMP mapping $PORT renewed."
        echo "Updating qbittorrent port to $PORT..."

        curl -i -X POST -d 'json={"listen_port": $PORT}' http://localhost:8080/api/v2/app/setPreferences

        sleep 45
    done
