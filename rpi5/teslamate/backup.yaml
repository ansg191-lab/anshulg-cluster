apiVersion: batch/v1
kind: CronJob
metadata:
  name: teslamate-backup
spec:
  schedule: "14 8 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
            - name: pgdump
              image: postgres:17.5@sha256:cb51e9f73d5b6fd77340999cc0fdfcf56a1d580daa6f4c2f6c72264993e6de34
              imagePullPolicy: IfNotPresent
              command:
                - sh
                - -c
                - |
                  pg_dump -p 5432 teslamate > /backup/backup.sql
              env:
                - name: PGHOST
                  valueFrom:
                    secretKeyRef:
                      name: teslamate-cluster-superuser
                      key: host
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: teslamate-cluster-superuser
                      key: user
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: teslamate-cluster-superuser
                      key: password
              volumeMounts:
                - mountPath: /backup
                  name: backup
          containers:
            - name: restic
              image: creativeprojects/resticprofile:0.31.0@sha256:7b1c8b37edb1f5c64361b7bddb0d4bc57287f776d5ec55d07cd7bc89165c5973
              imagePullPolicy: IfNotPresent
              command: [ "resticprofile", "backup" ]
              env:
                - name: RESTIC_REST_USERNAME
                  value: "teslamate"
                - name: RESTIC_REST_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: restPassword
                      name: secrets
              volumeMounts:
                - mountPath: /resticprofile/profiles.yaml
                  name: profile
                  subPath: profiles.yaml
                - mountPath: /resticprofile/password
                  name: secrets
                  subPath: password
                - mountPath: /backup
                  name: backup
          restartPolicy: OnFailure
          volumes:
            - name: backup
              emptyDir: { }
            - name: profile
              configMap:
                name: resticprofile
            - name: secrets
              secret:
                secretName: secrets
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: resticprofile
data:
  profiles.yaml: |
    version: "1"

    default:
      repository: "rest:https://restic.anshulg.com/teslamate/"
      initialize: true
      password-file: "/resticprofile/password"
      compression: "max"
      force-inactive-lock: true

      env:
        RESTIC_HOST: "teslamate"

      retention:
        before-backup: false
        after-backup: true
        keep-daily: 7
        keep-weekly: 4
        keep-monthly: 1
        prune: true
        host: false

      backup:
        source:
          - "/backup"
        tag:
          - "teslamate"
