apiVersion: batch/v1
kind: CronJob
metadata:
  name: kometa
  labels:
    app.kubernetes.io/name: kometa
spec:
  schedule: "0 8 * * *"
  timeZone: "America/Los_Angeles"
  concurrencyPolicy: Forbid
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: kometa
    spec:
      template:
        spec:
          initContainers:
            - name: copy-config
              image: busybox:1.37.0@sha256:e3652a00a2fabd16ce889f0aa32c38eec347b997e73bd09e69c962ec7f8732ee
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -euxc
                - |
                  cp /src-config/* /config/
              volumeMounts:
                - mountPath: /config
                  name: config
                - mountPath: /src-config
                  name: src-config
          containers:
            - name: kometa
              image: kometateam/kometa:v2.2.2@sha256:32992226d1a505da3ed5d4e9c97bed8a6deb7aef36cd5ef8b1f519762607df45
              imagePullPolicy: IfNotPresent
              args:
                - --run
              volumeMounts:
                - mountPath: /config
                  name: config
          restartPolicy: OnFailure
          volumes:
            - name: config
              persistentVolumeClaim:
                claimName: kometa-pvc
            - name: src-config
              secret:
                secretName: kometa-config
