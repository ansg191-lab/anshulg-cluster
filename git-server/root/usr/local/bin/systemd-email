#!/bin/sh
# systemd-email - Send email notifications about a systemd unit's full status
# Usage: systemd-email <email_address> <unit_name>

# Check args
if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <email_address> <unit_name>"
    exit 1
fi

EMAIL_ADDRESS="$1"
UNIT_NAME="$2"

# Check if GPG key exists for the recipient
if ! gpg --list-keys "$EMAIL_ADDRESS" >/dev/null 2>&1; then
    echo "Error: No GPG public key found for $EMAIL_ADDRESS"
    echo "Please import the recipient's public key first:"
    echo "  gpg --import recipient_key.asc"
    exit 1
fi

# Check if we have a default signing key
if ! gpg --list-secret-keys >/dev/null 2>&1; then
    echo "Error: No GPG secret key found for signing"
    echo "Please generate or import a GPG key for signing"
    exit 1
fi

{
    echo "### SYSTEMD STATUS ###"
    systemctl status --no-pager --lines=0 --full "$UNIT_NAME"

    echo ""
    echo "### FULL LOGS ###"
    journalctl -u "$UNIT_NAME" --no-pager --since="$(systemctl show "$UNIT_NAME" -p ExecMainStartTimestamp --value)"
} | gpg --encrypt --sign --armor --recipient "$EMAIL_ADDRESS" \
  | mail -s "Systemd Unit Failure: $UNIT_NAME (GPG Encrypted)" \
		-a "From: systemd <root@$(cat /etc/mailname)>" \
		"$EMAIL_ADDRESS"
