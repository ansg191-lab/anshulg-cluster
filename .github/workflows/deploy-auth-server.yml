name: Deploy Auth Server

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "auth-server/**"
      - ".github/workflows/deploy-auth-server.yml"

jobs:
  shellcheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # 2.0.0
        with:
          scandir: './auth-server'

  check-caddy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Caddy
        uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
        with:
          repo: caddyserver/caddy

      - name: Caddy Verify
        run: caddy adapt --config ./auth-server/root/etc/caddy/Caddyfile

  deploy:
    runs-on: ubuntu-latest
    needs:
      - check-caddy
      - shellcheck
    environment:
      name: 'production'
      url: 'https://auth.anshulg.com'

    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: shogo82148/actions-setup-perl@fa3bdcb0144a50651e317f30949bb4491e74a6e4 # v1.37.0
        with:
          perl-version: "5.38"
          install-modules-with: cpanm

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          credentials_json: ${{ secrets.GCLOUD_CREDENTIALS }}

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1
        with:
          project_id: anshulg-cluster

      - name: Get runner IP
        id: get_ip
        run: |
          set -euo pipefail
          ip=$(curl -s https://api.ipify.org)
          echo "ip=$ip" >> "$GITHUB_OUTPUT"

      - name: Whitelist runner IP in GCP
        id: fw_add
        env:
          RUNNER_IP: ${{ steps.get_ip.outputs.ip }}
        run: |
          set -euo pipefail
          RULE_NAME="gh-ssh-allow-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "rule_name=$RULE_NAME" >> "$GITHUB_OUTPUT"

          gcloud compute firewall-rules create "$RULE_NAME" \
            --network="default" \
            --direction=INGRESS \
            --priority=100 \
            --action=ALLOW \
            --rules=tcp:22 \
            --source-ranges="${RUNNER_IP}/32" \
            --target-tags="kanidm"

      - uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.GOOGLE_SSH_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H auth.anshulg.com >> ~/.ssh/known_hosts

      - name: Run deployment script
        run: ./x.pl deploy auth

      - name: Remove runner IP from GCP
        if: always()
        run: |
          set -euo pipefail
          RULE_NAME="${{ steps.fw_add.outputs.rule_name }}"
          if [ -n "$RULE_NAME" ]; then
            gcloud compute firewall-rules delete "$RULE_NAME" --quiet || true
          fi
