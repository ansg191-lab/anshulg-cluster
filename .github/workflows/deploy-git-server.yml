name: Deploy Git Server

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "git-server/**"
      - ".github/workflows/deploy-git-server.yml"

jobs:
  shellcheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # 2.0.0
        with:
          scandir: './git-server'

  check-caddy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Install Caddy
        uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
        with:
          repo: caddyserver/caddy

      - name: Caddy Verify
        run: caddy adapt --config ./git-server/root/etc/caddy/Caddyfile

  deploy:
    runs-on: ubuntu-latest
    needs:
      - check-caddy
      - shellcheck
    environment:
      name: 'production'
      url: 'https://git.anshulg.com'

    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: shogo82148/actions-setup-perl@22423f01bde48fb88785c007e3166fbbbd8e892a # v1.34.0
        with:
          perl-version: "5.38"
          install-modules-with: cpanm

      - uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.GOOGLE_SSH_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H git.anshulg.com >> ~/.ssh/known_hosts

      - name: Run deployment script
        run: ./x.pl deploy git
