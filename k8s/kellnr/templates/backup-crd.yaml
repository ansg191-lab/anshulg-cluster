apiVersion: restic.anshulg.com/v1alpha1
kind: ScheduledBackup
metadata:
  name: kellnr-backup
spec:
  schedule: "0 * * * *"
  backup:
    restic:
      repository:
        type: rest
        uri: https://restic.anshulg.com/kellnr-restic/
        password:
          name: backup-secrets
          key: kellnr.txt
        restCredentials:
          username:
            name: backup-secrets
            key: restic-username
          password:
            name: backup-secrets
            key: restic-password
      compression: max
      backup:
        tag:
          - kellnr
      retention:
        beforeBackup: false
        afterBackup: true
        keepHourly: 24
        keepDaily: 7
        keepWeekly: 4
        keepMonthly: 12
        keepYearly: 1
        prune: true
    resticProfile:
      args:
        - backup
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  app.kubernetes.io/instance: kellnr
                  app.kubernetes.io/name: kellnr
    volume:
      mounts:
        - mountPath: /opt/kdata
          name: kellnr-storage
      volumes:
        - name: kellnr-storage
          persistentVolumeClaim:
            claimName: kellnr
