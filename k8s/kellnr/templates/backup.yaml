apiVersion: batch/v1
kind: CronJob
metadata:
  name: kellnr-backup
spec:
  schedule: "0 13 * * *"
  concurrencyPolicy: Replace
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
            - name: pgdump
              image: postgres:17.5@sha256:fa6e5715d6521a4a9d4cc47015b6eb8fc4f2abaae4bc015be7a5209328ce196c
              imagePullPolicy: IfNotPresent
              command:
                - sh
                - -c
                - |
                  pg_dump -Fd kellnr -f /backup -v
              env:
                - name: PGHOST
                  value: kellnr-postgresql
                - name: PGPORT
                  value: "5432"
                - name: PGUSER
                  value: kellnr
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: database-secrets
                      key: password
              volumeMounts:
                - mountPath: /backup
                  name: backup
          containers:
            - name: kellnr-backup
              image: creativeprojects/resticprofile:0.31.0@sha256:bd5f51a2563e890e59d8b202e5580845c74f93d10aae44b5807d129f2038f76c
              imagePullPolicy: IfNotPresent
              command:
                - resticprofile
                - backup
              env:
                - name: RESTIC_REST_USERNAME
                  valueFrom:
                    secretKeyRef:
                      key: restic-username
                      name: backup-secrets
                - name: RESTIC_REST_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: restic-password
                      name: backup-secrets
              volumeMounts:
                - mountPath: /resticprofile/profiles.yaml
                  name: profile
                  subPath: profiles.yaml
                - mountPath: /resticprofile/kellnr.txt
                  name: backup-secrets
                  subPath: kellnr.txt
                - mountPath: /opt/kdata
                  name: kellnr-storage
                  readOnly: true
                - mountPath: /backup
                  name: backup
                  readOnly: true
          restartPolicy: OnFailure
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchLabels:
                      app.kubernetes.io/instance: kellnr
                      app.kubernetes.io/name: kellnr
          volumes:
            - name: backup
              emptyDir: {}
            - name: kellnr-storage
              persistentVolumeClaim:
                claimName: kellnr
            - name: profile
              configMap:
                name: restic-profile
            - name: backup-secrets
              secret:
                secretName: backup-secrets
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: restic-profile
data:
  profiles.yaml: |
    version: "1"

    global:
      restic-lock-retry-after: "1m"
      restic-stale-lock-age: "4h"

    default:
      repository: "rest:http://restic.restic.svc.cluster.local/kellnr-restic/"
      initialize: true
      password-file: "/resticprofile/kellnr.txt"
      compression: "max"
      force-inactive-lock: true

      env:
        RESTIC_HOST: "kellnr"

      retention:
        before-backup: false
        after-backup: true
        keep-hourly: 24
        keep-daily: 7
        keep-weekly: 4
        keep-monthly: 12
        keep-yearly: 1
        prune: true
        host: false

      backup:
        source:
          - "/opt/kdata"
          - "/backup"
        tag:
          - "kellnr"
