apiVersion: batch/v1
kind: CronJob
metadata:
  name: miniflux-backup
spec:
  schedule: "0 22 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cockroachdb-sa
          containers:
            - name: backup
              image: cockroachdb/cockroach:v24.2.5
              imagePullPolicy: IfNotPresent
              command:
                - sh
                - -c
                - >
                  cockroach sql --certs-dir=/cockroach/cockroach-certs --host=cockroachdb-public --database=miniflux
                  --execute "BACKUP DATABASE miniflux INTO 'gs://cockroacchdb-backup-bucket-8kmcx/miniflux?AUTH=implicit';"
              volumeMounts:
                - mountPath: /cockroach/cockroach-certs
                  name: client-certs
          restartPolicy: OnFailure
          volumes:
            - name: client-certs
              projected:
                sources:
                  - secret:
                      name: cockroachdb-node
                      items:
                        - key: ca.crt
                          path: ca.crt
                  - secret:
                      name: cockroachdb-root
                      items:
                        - key: tls.crt
                          path: client.root.crt
                        - key: tls.key
                          path: client.root.key
                defaultMode: 256
