apiVersion: apps/v1
kind: Deployment
metadata:
  name: hydroxide
  labels:
    app: hydroxide
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hydroxide
  template:
    metadata:
      name: hydroxide
      labels:
        app: hydroxide
    spec:
      initContainers:
        - name: copy-auth
          image: busybox:1.36
          command:
            - sh
            - -c
            - cp /config/auth.json /data/auth.json
          volumeMounts:
            - mountPath: /config
              name: auth
            - mountPath: /data
              name: data
      containers:
        - name: hydroxide
          image: ghcr.io/ansg191/containers/hydroxide:v0.2.29
          imagePullPolicy: IfNotPresent
          ports:
            - name: smtp
              containerPort: 1025
              protocol: TCP
            - name: imap
              containerPort: 1143
              protocol: TCP
            - name: carddav
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - mountPath: /config/hydroxide
              name: data
          #resources:
          #  requests:
          #    cpu: 250m
          #    memory: 500Mi
          #  limits:
          #    memory: 1Gi
          livenessProbe:
            tcpSocket:
              port: smtp
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: smtp
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      restartPolicy: Always
      volumes:
        - name: data
          emptyDir:
            medium: Memory
        - name: auth
          secret:
            secretName: hydroxide-auth
